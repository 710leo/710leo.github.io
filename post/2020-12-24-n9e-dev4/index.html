<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>夜莺二次开发指南-用户资源中心 | 秦叶宁的网志</title>
    <meta property="og:title" content="夜莺二次开发指南-用户资源中心 - 秦叶宁的网志">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-01-13T19:00:56&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-01-13T19:00:56&#43;08:00'>
        
    <meta name="Keywords" content="golang monitor aiops">
    <meta name="description" content="夜莺二次开发指南-用户资源中心">
        
    <meta name="author" content="秦叶宁">
    <meta property="og:url" content="http://www.qinyening.com/post/2020-12-24-n9e-dev4/">
    <link rel="shortcut icon" href='http://blog-1255977231.cos.ap-beijing.myqcloud.com/151300.jpg'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?62edf66253cb0df3cc6c28c802e8bf1f";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://www.qinyening.com/">
                        秦叶宁的网志
                    </a>
                
                <p class="description">专注于可观测性、AIOps</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://www.qinyening.com/">首页</a>
                    
                    <a  href="http://www.qinyening.com/archives/" title="归档">归档</a>
                    
                    <a  href="http://www.qinyening.com/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">夜莺二次开发指南-用户资源中心</h1>
        </header>
        
        <date class="post-meta meta-date">
            2021年1月13日
        </date>
        
        
        
        
        <div class="post-content">
            <h3 id="前言">前言</h3>
<p>本系列将对夜莺平台各个模块的主要逻辑进行介绍，方便大家进行二次开发，本篇是系列的第四篇，用户资源中心模块</p>
<p>首先贴下夜莺的项目地址和架构图，正在使用夜莺的读者欢迎给夜莺加一个star</p>
<ul>
<li>github地址 <a href="https://github.com/didi/nightingale">https://github.com/didi/nightingale</a></li>
<li>v3.0架构图如下</li>
</ul>
<p>
        <img class="mx-auto" alt="img" src="https://static001.geekbang.org/infoq/07/0722fd1f389e572364e00bea036b5eff.png" />   
    </p>
<p>本节主要讲解用户资源中心的RDB模块，RDB模块是夜莺平台的基座，提供了用户信息、组织资源树、用户权限等功能，这些功能的实现都比较简单，大家可以直接看 <a href="https://github.com/didi/nightingale/blob/master/src/modules/rdb/http/router.go">http/router.go</a> 的代码 ，里面列举了 rdb 的所有 http 接口，本篇主要介绍下第三方系统如何来接入夜莺平台</p>
<h3 id="用户认证接入">用户认证接入</h3>
<p>夜莺提供了一套完整的用户体系，其他系统可以通过接入夜莺的用户认证来复用夜莺的用户体系。下面介绍一下接入用户认证的流程</p>
<ol>
<li>首先待接入系统 A 和夜莺平台的 cookie 要可以复用</li>
<li>当用户在夜莺平台登录之后，会把和用户相关的 sessionId 写入到 cookie 中，当用户再访问接入系统 A 时，系统A从 cookie里可以拿到 sessionId，cookie 的 key 为 ecmc-sid</li>
<li>通过调研 rdb 提供的接口，查询用户的用户名，如果能查询说明用户是合法的而且已经登录了，如果查不到则说明用户没有登陆，可以让前端将页面跳转到夜莺的登陆页面</li>
</ol>
<p>根据 sessionId 查询用户信息的接口如下</p>
<pre tabindex="0"><code>v1.GET(&#34;/sessions/:sid&#34;, v1SessionGet) //查询用户名
v1.GET(&#34;/sessions/:sid/user&#34;, v1SessionGetUser) //查询用户信息
</code></pre><p>关于用户信息这里展开说一下，首先看下用户的数据结构</p>
<pre tabindex="0"><code>type User struct {
    Id           int64     `json:&#34;id&#34;`
    UUID         string    `json:&#34;uuid&#34; xorm:&#34;&#39;uuid&#39;&#34;`
    Username     string    `json:&#34;username&#34;`
    Organization string    `json:&#34;organization&#34;`
    IsRoot       int       `json:&#34;is_root&#34;`
    LeaderId     int64     `json:&#34;leader_id&#34;`
    LeaderName   string    `json:&#34;leader_name&#34;`
    //...
}
</code></pre><p>User 数据结构中提供了一个 LeaderId 字段，可以设置用户 leader 是谁，这样就具备了简单的企业组织结构的表达能力，在一些审批和升级事件中可以使用这个字段，User 数据结构中还有一个 Organization 字段，所以可以根据 LeaderId 和 Organization 绘制出公司的人员组织结构，大家有需要可以自己实现这个功能。</p>
<h3 id="资源接入">资源接入</h3>
<p>夜莺使用组织资源树的方式来管理资源，夜莺平台的用户权限、告警策略、采集策略都是基于组织资源树来设计的。夜莺的目标是成为基础架构平台底座，让大家可以基于夜莺开发适合公司自己的基础平台。所以为了可以让各种PAAS类平台接入到夜莺平台，我们抽象了租户和项目两个特殊的节点类别。简单的节点组织方式可以为：租户&mdash;&gt;项目&mdash;&gt;模块，复杂一点的可以是：租户&mdash;&gt;组织&mdash;&gt;项目&mdash;&gt;模块&mdash;&gt;集群。</p>
<p>下面介绍下，第三方系统如何把资源自动注册到夜莺平台，夜莺提供了专门的资源注册和销毁的接口</p>
<pre tabindex="0"><code>// RDB作为一个类似CMDB的东西，接收各个子系统注册过来的资源，其他资源都是依托于项目创建的，RDB会根据nid自动挂载资源到相应节点
v1.POST(&#34;/resources/register&#34;, v1ResourcesRegisterPost)
// 资源销毁的时候，需要从库里清掉，同时需要把节点挂载关系也删除，一个资源可能挂载在多个节点，都要统统干掉
v1.POST(&#34;/resources/unregister&#34;, v1ResourcesUnregisterPost)
</code></pre><p>拿 RDS 平台接入夜莺举例，RDS 平台需要把用户创建的 RDS 实例和夜莺的项目节点绑定起来，夜莺提供了 /tree/projs 的接口，只展示用户拥有权限的项目节点，RDS 平台的前端页面可以调用这个接口，在用户创建 RDS 实例时，先让用户选择项目节点，这样就可以把实例和项目节点关联起来，等实例创建好之后，RDS 平台可以调用夜莺的资源注册接口，把RDS资源注册到夜莺的服务树上面。下面是rds注册到 rdb 之后的截图</p>
<p>
        <img class="mx-auto" alt="img" src="https://static001.geekbang.org/infoq/eb/eb2056024b3efa10fc083cff066d4928.png" />   
    </p>
<p>通过这种方式，RDS 平台可以直接复用夜莺的权限管理能力和告警监控能力，将 RDS 实例的英文标识作为 endpoint 上报监控到夜莺之后，可以直接在夜莺平台查看监控和配置告警。</p>
<h3 id="权限接入">权限接入</h3>
<p>通过上文RDS平台将资源绑定到节点之后，就可以复用夜莺的权限管理体系了，夜莺提供了两类页面，一类是页面角色，一类是资源角色。</p>
<p>如果系统有些页面或者按钮只可以给管理员看到，不能让普通用户看到，这个时候可以使用页面角色来配置权限</p>
<p>资源角色在涉及到某些资源相关的操作权限时使用，首先资源角色在配置的时候，需要框定一个范围，这个范围就是服务节点，也就是上文提到的项目节点，通过在某个项目节点给某个用户赋予某个角色，来控制该用户是否有权限来对RDS资源进行操作。</p>
<p>下面介绍下集成步骤</p>
<ol>
<li>待接入的平台要梳理自己的业务，看哪些页面/操作需要受权限管控，每个页面/操作用一个权限点表示（底层实现是一个字符串，比如 rds_instance_write 表示RDS平台对项目下资源的写操作权限）</li>
<li>将梳理好的权限点，添加到 rdb 的配置文件<a href="https://github.com/didi/nightingale/blob/master/etc/lop.yml">lop.yml</a> 和 <a href="https://github.com/didi/nightingale/blob/master/etc/gop.yml">gop.yml</a> 中</li>
<li>根据平台的使用场景，创建相关的角色并配置好权限点</li>
<li>当用户在接入的平台操作时，比如在某个项目下创建rds实例，可以根据项目id+用户名+权限点调用 rdb的权限校验接口，来校验用户是否有权限做此操作，查询样例如下</li>
</ol>
<pre tabindex="0"><code>curl -H &#34;X-Srv-Token: rdb-builtin-token&#34; &#39;http://rdb.addr:8000/v1/rdb/can-do-node-op?nid=1&amp;username=root&amp;op=rdb_perm_grant&#39;
{&#34;dat&#34;:true,&#34;err&#34;:&#34;&#34;}
</code></pre><p>本篇文章到此就结束了，下篇将为大家介绍资产管理平台（AMS）模块</p>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://www.qinyening.com/">秦叶宁</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://www.qinyening.com/post/2020-12-24-n9e-dev4/">http://www.qinyening.com/post/2020-12-24-n9e-dev4/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/%E7%9B%91%E6%8E%A7'>监控</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                    <footer id="footer">
    <div class="container">
      &copy; 2025 <a rel="nofollow" href="http://www.qinyening.com/">秦叶宁的网志</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io">Hugo</a> &amp; <a rel="nofollow noreferer noopener" href="https://github.com/flysnow-org/maupassant-hugo">maupassant theme</a>.
    </div>
</footer>

<script type="text/javascript" src="/js/app.js" defer></script>


<script type="text/javascript" src="/js/douban.js" defer></script>
<script type="text/javascript" src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' defer></script>
                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='http://www.qinyening.com/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://www.qinyening.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://www.qinyening.com/post/2021-11-17-stability/" title="运维体系建设思考-稳定性篇">运维体系建设思考-稳定性篇</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2020-12-24-n9e-dev6/" title="夜莺二次开发指南-任务执行中心">夜莺二次开发指南-任务执行中心</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2020-12-24-n9e-dev4/" title="夜莺二次开发指南-用户资源中心">夜莺二次开发指南-用户资源中心</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2020-12-24-n9e-dev5/" title="夜莺二次开发指南-资产设备管理">夜莺二次开发指南-资产设备管理</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2020-12-24-n9e-dev3/" title="夜莺二次开发指南-监控系统（3）">夜莺二次开发指南-监控系统（3）</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2020-12-24-n9e-dev2/" title="夜莺二次开发指南-监控系统（2）">夜莺二次开发指南-监控系统（2）</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2020-12-24-n9e-dev1/" title="夜莺二次开发指南-监控系统（1）">夜莺二次开发指南-监控系统（1）</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2019-06-29-monitor01/" title="企业监控平台建设-需求分析篇">企业监控平台建设-需求分析篇</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2017-08-27-deep-work/" title="职业思考：深度工作">职业思考：深度工作</a>
    </li>
    
    <li>
        <a href="http://www.qinyening.com/post/2016-08-07-urlooker/" title="Urlooker：Web 可用性监控系统">Urlooker：Web 可用性监控系统</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="http://www.qinyening.com/categories/IT%E6%8A%80%E6%9C%AF/">IT技术 (3)</a></li>
    
    <li><a href="http://www.qinyening.com/categories/%E8%AE%A4%E7%9F%A5%E7%A7%91%E5%AD%A6/">认知科学 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="http://www.qinyening.com/tags/%E5%AE%89%E5%85%A8/">安全</a>
    
    <a href="http://www.qinyening.com/tags/%E7%9B%91%E6%8E%A7/">监控</a>
    
    <a href="http://www.qinyening.com/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
    
    <a href="http://www.qinyening.com/tags/%E9%9A%8F%E6%83%B3/">随想</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://blog.x2know.org" title="秦叶宁的网志">秦叶宁的网志</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.yangzhiping.com/" title="阳志平的网志">阳志平的网志</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.v2ex.com/go/create" title="V2EX">V2EX</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://www.qinyening.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>